name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      # 1. Checkout (Required to access the local action)
      - uses: actions/checkout@v4

      # 2. Run the Reusable Composite Action (Replaces Steps 2-6)
      - name: Setup Environment
        uses: ./.github/actions/setup_poetry_gcp
        with:
          gcp_credentials: ${{ secrets.GCP_CREDENTIALS }}
          python-version: "3.11"

      # 7. Linting
      - name: Lint with ruff
        run: poetry run ruff check functions/

      - name: Check code formatting with black
        run: poetry run black --check functions/

      - name: Type check with mypy
        run: |
          poetry run mypy functions/my_function_audiences

      # 8. Run Tests
      - name: Run unit tests
        run: |
          poetry run pytest functions/tests/unit \
            --cov=functions/my_function_audiences \
            --cov-report=term-missing \
            -v

  publish-docs:
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout
      - uses: actions/checkout@v4

      # 2. Reuse the exact same setup logic
      - name: Setup Environment
        uses: ./.github/actions/setup_poetry_gcp
        with:
          gcp_credentials: ${{ secrets.GCP_CREDENTIALS }}
          python-version: "3.11"

      # Specific Doc Tools
      - name: Install Doc Tools
        run: |
          pip install beautifulsoup4 sphinx sphinxcontrib-confluencebuilder sphinx-design myst-parser

      - name: Build docs HTML (pdoc)
        env:
          PYTHONPATH: ${{ github.workspace }}/functions
        run: |
          poetry run pdoc -o site my_function_audiences

      - name: Convert HTML to RST
        run: |
          mkdir -p docs/source
          cp README.md docs/source/readme.md
          poetry run python scripts/pdoc_to_rst.py functions/site docs/source

      - name: Publish to Confluence
        env:
          CONFLUENCE_URL: ${{ secrets.CONFLUENCE_URL }}
          CONFLUENCE_USERNAME: ${{ secrets.CONFLUENCE_USERNAME }}
          CONFLUENCE_API_KEY: ${{ secrets.CONFLUENCE_API_KEY }}
          CONFLUENCE_SPACE_KEY: ${{ secrets.CONFLUENCE_SPACE_KEY }}
          CONFLUENCE_PARENT_PAGE_KEY: ${{ secrets.CONFLUENCE_PARENT_PAGE_KEY }}
        run: |
          python3 -m sphinx -M confluence docs/source docs/_build -E -a